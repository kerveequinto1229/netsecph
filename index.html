<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trace and Breach</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { font-size: 1.5rem; }
    .hidden { display: none; }
    button { padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #0056b3; }
    input { padding: 8px; width: 100%; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ACCESS GRANTED!</h2>
    <p>Breach the Netsec x Eclypsium Portal to Register</p>
    <h1>STAGE 1: 	Authenticate Your Identity to Begin the Breach.</h1>
    <div id="station-form">
      <label>Enter your Name/ID:</label>
      <input type="text" id="playerName" placeholder="Your name...">
      <div id="prev-code-section" class="hidden">
        <label>Enter previous station code:</label>
        <input type="text" id="prevCode" placeholder="Previous code...">
      </div>
      <button onclick="startStation()">Start</button>
    </div>

    <div id="question-section" class="hidden">
      <h2 id="question-text"></h2>
      <div id="options"></div>
    </div>

    <div id="result-section" class="hidden">
      <h2>Congratulations!</h2>
      <p>Your unlock code for the next station:</p>
      <h3 id="unlock-code"></h3>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const stationNumber = parseInt(urlParams.get('station')) || 1;

    const questionPools = {
      1: [
        { q: "What is 2+2?", options: ["3","4","5"], answer: "4" },
        { q: "What color is the sky?", options: ["Blue","Green","Red"], answer: "Blue" }
      ],
      2: [
        { q: "What is the capital of France?", options: ["Paris","Rome","Berlin"], answer: "Paris" },
        { q: "Which is a fruit?", options: ["Carrot","Apple","Potato"], answer: "Apple" }
      ],
      3: [
        { q: "What is 5*3?", options: ["15","20","10"], answer: "15" },
        { q: "Which is an animal?", options: ["Chair","Dog","Rock"], answer: "Dog" }
      ],
      4: [
        { q: "What planet do we live on?", options: ["Mars","Earth","Venus"], answer: "Earth" },
        { q: "What is H2O?", options: ["Water","Oxygen","Fire"], answer: "Water" }
      ]
    };

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    async function generateHash(input) {
      const msgUint8 = new TextEncoder().encode(input);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 4).toUpperCase();
    }

    // Show previous code field immediately if station > 1
    if (stationNumber > 1) {
      document.getElementById("prev-code-section").classList.remove("hidden");
    }

    async function startStation() {
      const name = document.getElementById("playerName").value.trim();
      if (!name) { alert("Please enter your name/ID"); return; }

      if (stationNumber > 1) {
        const enteredCode = document.getElementById("prevCode").value.trim();
        const expectedCode = "STN" + (stationNumber-1) + "-" + await generateHash(name + (stationNumber-1));
        if (enteredCode !== expectedCode) {
          alert("Invalid previous station code!");
          return;
        }
      }

      document.getElementById("station-form").classList.add("hidden");
      showQuestion(name);
    }

    function showQuestion(name) {
      const pool = questionPools[stationNumber];
      const randomQ = pool[Math.floor(Math.random() * pool.length)];

      document.getElementById("question-text").innerText = randomQ.q;
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      shuffle(randomQ.options).forEach(opt => {
        const btn = document.createElement("button");
        btn.innerText = opt;
        btn.onclick = async () => {
          if (opt === randomQ.answer) {
            const code = "STN" + stationNumber + "-" + await generateHash(name + stationNumber);
            document.getElementById("question-section").classList.add("hidden");
            document.getElementById("unlock-code").innerText = code;
            document.getElementById("result-section").classList.remove("hidden");
          } else {
            alert("Wrong answer! Try again.");
          }
        };
        optionsDiv.appendChild(btn);
      });

      document.getElementById("question-section").classList.remove("hidden");
    }
  </script>
</body>
</html>
